{% extends "base.html" %}

{% block content %}
<style>
    /* Professional Lab Styles */
    .lab-container {
        display: flex;
        height: 85vh; /* Full height minus navbar */
        background-color: #1e1e1e;
        color: #c0c0c0;
    }
    
    /* LEFT PANEL: Mission Control */
    .mission-panel {
        width: 30%;
        background-color: #252526;
        border-right: 1px solid #333;
        padding: 20px;
        overflow-y: auto;
    }
    
    /* RIGHT PANEL: The Target */
    .target-panel {
        width: 70%;
        padding: 20px;
        background-color: #1e1e1e;
        display: flex;
        flex-direction: column;
    }

    /* Terminal Styling */
    .terminal-window {
        background-color: #000;
        border: 1px solid #333;
        border-radius: 5px;
        font-family: 'Consolas', 'Monaco', monospace;
        padding: 15px;
        flex-grow: 1;
        overflow-y: auto;
        color: #0f0; /* Hacker Green */
        margin-top: 20px;
    }

    .flag-input {
        background: #333;
        border: 1px solid #555;
        color: white;
    }

    .success-animation {
        animation: blink 1s infinite;
        color: #0f0;
        font-weight: bold;
    }

    @keyframes blink { 50% { opacity: 0; } }
</style>

<div class="container-fluid p-0">
    <div class="lab-container">
        
        <div class="mission-panel">
            <h4 class="text-white">üïµÔ∏è Mission Brief</h4>
            <hr class="bg-secondary">
            <p><strong>Target:</strong> PyGuard Bank Internal Server</p>
            <p><strong>Objective:</strong> Dump the database to find the Administrator's secret Flag.</p>
            
            <div class="alert alert-dark border-secondary mt-4">
                <small class="text-muted">STEP 1:</small><br>
                The search box on the right is vulnerable. Try to inject a payload that forces the database to return all rows.
            </div>

            <div class="alert alert-dark border-secondary">
                <small class="text-muted">STEP 2:</small><br>
                Locate the text starting with <code>FLAG{...}</code>.
            </div>

            <div class="mt-5">
                <label><strong>üö© Submit Flag:</strong></label>
                <div class="input-group mb-3">
                    <input type="text" id="flagInput" class="form-control flag-input" placeholder="Paste FLAG{...} here">
                    <button class="btn btn-success" onclick="verifyFlag()">Submit</button>
                </div>
                <div id="flagResult"></div>
            </div>
        </div>

        <div class="target-panel">
            <div class="card bg-dark border-secondary mb-3">
                <div class="card-header border-secondary text-white">
                    üñ•Ô∏è <strong>Bank_User_Search_v1.0.exe</strong>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row">
                            <div class="col-md-8">
                                <input type="text" name="username" class="form-control bg-secondary text-white border-0" placeholder="Enter username to search..." required>
                            </div>
                            <div class="col-md-4">
                                <input type="hidden" name="security_mode" value="unsafe">
                                <button type="submit" class="btn btn-primary w-100">Run Query</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="terminal-window">
                <div class="mb-2 text-muted">root@pyguard-server:~# ./query_db.py</div>
                
                {% if query %}
                    <div>> Executing: <span class="text-warning">{{ query }}</span></div>
                {% endif %}

                {% if error %}
                    <div class="text-danger">> ERROR: {{ error }}</div>
                {% elif result %}
                    <div class="mt-2">> <span class="text-success">SUCCESS: {{ result|length }} records found.</span></div>
                    <div class="table-responsive mt-2">
                        <table class="table table-dark table-sm table-bordered" style="color: #ccc;">
                            <thead>
                                <tr style="color: #0f0;"><th>ID</th><th>USER</th><th>DATA</th></tr>
                            </thead>
                            <tbody>
                                {% for row in result %}
                                <tr>
                                    <td>{{ row[0] }}</td>
                                    <td>{{ row[1] }}</td>
                                    <td>{{ row[2] }}</td> </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-muted">> Waiting for input...</div>
                {% endif %}
                
                <div class="mt-2"><span class="blink">_</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    function verifyFlag() {
        const flag = document.getElementById('flagInput').value;
        const resultBox = document.getElementById('flagResult');

        fetch('/check_flag', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'flag_submission=' + encodeURIComponent(flag)
        })
        .then(response => response.text())
        .then(data => {
            if (data === "CORRECT") {
                resultBox.innerHTML = '<div class="alert alert-success mt-2">üéâ MISSION ACCOMPLISHED! FULL MARKS AWARDED.</div>';
                // Trigger confetti logic here if you want to be fancy
            } else {
                resultBox.innerHTML = '<div class="alert alert-danger mt-2">‚ùå Incorrect Flag. Try again.</div>';
            }
        });
    }
</script>
{% endblock %}